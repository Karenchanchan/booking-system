<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¼å°åƒè§€ãƒ»é»ååˆ†çµ„æ¨™ç±¤ç³»çµ±</title>
    <!-- å¼•å…¥ html2canvas èˆ‡ jspdf (ä»¥å‚™æ—¥å¾Œæ“´å……åˆ—å°ï¼Œä½†æœ¬ç³»çµ±ä½¿ç”¨ç€è¦½å™¨ç›´æ¥åˆ—å°æ¨™ç±¤) -->
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            background: #f2f7fc;
            font-family: 'Segoe UI', 'Microsoft YaHei', å¾®è»Ÿæ­£é»‘é«”, sans-serif;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .system-container {
            max-width: 1400px;
            width: 100%;
            background: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border-radius: 28px;
            padding: 30px 35px;
        }
        h1 {
            font-size: 1.9rem;
            font-weight: 600;
            color: #0a4b7a;
            border-left: 10px solid #ffb347;
            padding-left: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        h1 small {
            font-size: 0.9rem;
            font-weight: normal;
            color: #5e7e9c;
            margin-left: 8px;
        }
        .two-columns {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        .left-panel {
            flex: 1.2;
            min-width: 400px;
        }
        .right-panel {
            flex: 1;
            min-width: 350px;
            background: #f9fbff;
            border-radius: 20px;
            padding: 20px;
            box-shadow: inset 0 0 0 1px rgba(0,70,120,0.08);
        }
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,20,40,0.03);
            border: 1px solid #e9f0f5;
        }
        .card h2 {
            font-size: 1.3rem;
            color: #1d4e6f;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px dashed #cbdae4;
            padding-bottom: 10px;
        }
        .student-master-list {
            background: #eef6fa;
            border-radius: 16px;
            padding: 15px;
            margin-top: 10px;
        }
        textarea {
            width: 100%;
            border: 2px solid #ccdfe9;
            border-radius: 16px;
            padding: 15px 18px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            background: white;
            transition: 0.2s;
        }
        textarea:focus {
            border-color: #2a8bbf;
            outline: none;
            box-shadow: 0 0 0 3px rgba(42,139,191,0.1);
        }
        .row-flex {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .input-group {
            flex: 1;
            min-width: 150px;
        }
        .input-group label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #3f6c8a;
            font-weight: 600;
            margin-bottom: 5px;
        }
        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ccdfe9;
            border-radius: 40px;
            font-size: 0.95rem;
            background: white;
            transition: 0.2s;
        }
        input:focus {
            border-color: #2a8bbf;
            outline: none;
            box-shadow: 0 0 0 3px rgba(42,139,191,0.1);
        }
        button {
            background: #1e6e9c;
            border: none;
            color: white;
            font-weight: 600;
            padding: 12px 28px;
            border-radius: 40px;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 14px rgba(0,60,100,0.1);
        }
        button:hover {
            background: #135b82;
            transform: translateY(-2px);
            box-shadow: 0 12px 18px rgba(0,60,100,0.15);
        }
        .btn-warning {
            background: #f39c12;
            color: #1d2c3a;
        }
        .btn-warning:hover {
            background: #e08e0b;
        }
        .btn-light {
            background: #d4e3ed;
            color: #1a4058;
            box-shadow: none;
        }
        .btn-light:hover {
            background: #c2d6e4;
        }
        .group-count-area {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0 10px;
        }
        #groupCount {
            width: 100px;
            text-align: center;
            font-weight: 600;
        }
        .today-attendance {
            background: #ffffffd9;
            border-radius: 18px;
            padding: 18px;
            margin: 15px 0;
            border: 2px solid #aad0e6;
        }
        .attendance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .badge {
            background: #0a4b7a;
            color: white;
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 0.8rem;
        }
        .student-check-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #d8e6ed;
            border-radius: 16px;
            padding: 10px;
            background: white;
            margin-top: 10px;
        }
        .student-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #eaf1f6;
            font-size: 1rem;
        }
        .student-item:last-child {
            border-bottom: none;
        }
        .student-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 15px;
            accent-color: #2a8bbf;
            border-radius: 5px;
        }
        .label-preview-section {
            background: white;
            border-radius: 24px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #f1c6a0;
            box-shadow: 0 6px 0 #ffe4ce;
        }
        .label-container {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: flex-start;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
            padding: 8px 4px;
        }
        .label-card {
            width: 180px;
            height: 100px;
            border-radius: 14px;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 12px;
            border-left: 12px solid;
            font-size: 0.95rem;
            transition: 0.1s;
            word-break: break-word;
        }
        .label-card .student-name {
            font-weight: 700;
            font-size: 1.1rem;
        }
        .label-card .group-tag {
            display: inline-block;
            background: rgba(0,0,0,0.06);
            padding: 4px 10px;
            border-radius: 40px;
            margin-top: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #1f5068;
        }
        .label-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 15px;
        }
        hr {
            border: none;
            border-top: 2px solid #d1e0e8;
            margin: 25px 0 15px;
        }
        .color-indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 4px;
            margin-right: 6px;
        }
        .footer-note {
            margin-top: 30px;
            font-size: 0.8rem;
            color: #6a8ca0;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="system-container">
    <h1>
        ğŸ« å¹¼ç¨šåœ’åƒè§€Â·å³æ™‚é»ååˆ†çµ„
        <small>æŒ‰ç•¶å¤©å‡ºå¸­å¹³å‡åˆ†çµ„ãƒ»å°å­¸ç”Ÿï¼‹å®¶é•·æ¨™ç±¤</small>
    </h1>
    
    <div class="two-columns">
        <!-- å·¦å´ï¼šå­¸ç”Ÿç¸½è¡¨è¼¸å…¥ï¼‹é»åï¼‹åˆ†çµ„æ§åˆ¶ -->
        <div class="left-panel">
            <div class="card">
                <h2>ğŸ“‹ 1. è²¼ä¸Šæœ¬æ¬¡é‚€è«‹å­¸ç”Ÿåå–®</h2>
                <textarea id="studentMasterInput" rows="5" placeholder="æ¯è¡Œä¸€ä½å­¸ç”Ÿå§“åï¼Œä¾‹å¦‚ï¼š&#10;é™³å¤§æ–‡&#10;æå°æ¬£&#10;å¼µå­è»’&#10;ä½•å®¶æ¬£&#10;é»ƒå­æ™´&#10; ...">é™³å¤§æ–‡
æå°æ¬£
å¼µå­è»’
ä½•å®¶æ¬£
é»ƒå­æ™´
æ—ä¸€è¬™
è‘‰å­è•
å³å®¥å»·</textarea>
                <div style="display: flex; justify-content: flex-end; margin-top: 12px;">
                    <button id="loadMasterBtn" class="btn-light">ğŸ“Œ è¼‰å…¥åå–®åˆ°é»åå€</button>
                </div>
            </div>
            
            <div class="card">
                <h2>âœ… 2. ç•¶å¤©å‡ºå¸­é»å</h2>
                <div class="today-attendance">
                    <div class="attendance-header">
                        <span style="font-weight:600;">ğŸ‘¥ å·²å ±åå­¸ç”Ÿ (é»é¸ä»Šæ—¥å‡ºå¸­)</span>
                        <span class="badge" id="attendanceCount">0/0</span>
                    </div>
                    <div id="studentChecklistContainer" class="student-check-list">
                        <!-- å‹•æ…‹ç”Ÿæˆæ ¸å–æ–¹å¡Š -->
                        <div style="color: #6a8ca0; text-align: center; padding: 15px;">è«‹å…ˆã€Œè¼‰å…¥åå–®åˆ°é»åå€ã€</div>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 18px;">
                        <button id="checkAllBtn" class="btn-light">âœ… å…¨é¸å‡ºå¸­</button>
                        <button id="uncheckAllBtn" class="btn-light">ğŸ”„ å…¨éƒ¨å–æ¶ˆ</button>
                    </div>
                </div>
                
                <div style="margin-top: 25px;">
                    <h2>ğŸ§‘â€ğŸ« 3. è¨­å®šåˆ†çµ„æ•¸ç›® & å³æ™‚åˆ†çµ„</h2>
                    <div class="group-count-area">
                        <div class="input-group">
                            <label>æœ¬æ¬¡åƒè§€åˆ†çµ„æ•¸</label>
                            <input type="number" id="groupCount" min="1" max="12" value="4" step="1">
                        </div>
                        <button id="assignGroupsBtn" style="background: #2e8b57;">ğŸ”„ ä¾ç…§å‡ºå¸­åå–®å¹³å‡åˆ†çµ„</button>
                    </div>
                    <p style="font-size: 0.85rem; color: #436b7c; margin-top: 5px;">
                        âš¡ ç³»çµ±æœƒå°‡ã€Œå·²å‹¾é¸å‡ºå¸­ã€çš„å­¸ç”Ÿå¹³å‡åˆ†åˆ°å„çµ„ï¼Œæ¯çµ„äººæ•¸ç›¡é‡ç›¸ç­‰ã€‚
                    </p>
                </div>
            </div>
            
            <!-- åˆ†çµ„çµæœæ‘˜è¦ -->
            <div class="card" style="background: #e1f0f5;">
                <h2>ğŸ“Š åˆ†çµ„æ‘˜è¦</h2>
                <div id="groupSummary">
                    <p style="color: #396377;">å°šæœªé€²è¡Œåˆ†çµ„ï¼Œè«‹è¨­å®šçµ„æ•¸ä¸¦é»æ“Šã€Œä¾ç…§å‡ºå¸­åå–®å¹³å‡åˆ†çµ„ã€ã€‚</p>
                </div>
            </div>
        </div>
        
        <!-- å³å´ï¼šå½©è‰²æ¨™ç±¤é è¦½ï¼‹åˆ—å°å€ -->
        <div class="right-panel">
            <h2 style="margin-top: 0; color: #0e4d64;">ğŸ·ï¸ å½©è‰²åˆ†çµ„æ¨™ç±¤ (é è¦½)</h2>
            <div style="background: #ffe9d7; padding: 12px 16px; border-radius: 16px; margin-bottom: 10px;">
                <span style="font-weight:600;">ğŸ¨ çµ„åˆ¥é…è‰²</span>
                <div id="colorPalette" style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 8px;">
                    <!-- å‹•æ…‹é¡¯ç¤ºçµ„åˆ¥é¡è‰² -->
                </div>
            </div>
            
            <div class="label-preview-section">
                <div style="display: flex; gap: 30px; align-items: baseline;">
                    <h3 style="font-size: 1.2rem; margin:0;">ğŸ–¨ï¸ å­¸ç”Ÿæ¨™ç±¤ + å®¶é•·æ¨™ç±¤</h3>
                    <span style="background: #fff1cf; padding: 5px 12px; border-radius: 40px; font-size:0.8rem;">
                        ğŸ“ å·¦å´è‰²æ¢ï¼çµ„åˆ¥é¡è‰²
                    </span>
                </div>
                <!-- æ¨™ç±¤å±•ç¤ºå€: å­¸ç”Ÿæ¨™ç±¤ èˆ‡ å®¶é•·æ¨™ç±¤ å…©åˆ—? é€™è£¡çµ±ä¸€åœ¨ä¸€å€‹å®¹å™¨å‘ˆç¾ï¼Œä½†æ¯å¼µlabelå‡æ¸…æ¥šæ¨™ç¤ºæ˜¯å­¸ç”Ÿorå®¶é•· -->
                <div id="labelPreviewArea" class="label-container">
                    <div style="color: #718e9e; width: 100%; text-align: center; padding: 20px;">ğŸ‘‰ å®Œæˆåˆ†çµ„å¾Œï¼Œæ¨™ç±¤æœƒè‡ªå‹•ç”¢ç”Ÿ</div>
                </div>
                
                <div class="label-actions">
                    <button id="printLabelsBtn" class="btn-warning">ğŸ–¨ï¸ åˆ—å°æ‰€æœ‰æ¨™ç±¤</button>
                    <button id="clearLabelsBtn" class="btn-light">ğŸ—‘ï¸ æ¸…ç©ºé è¦½</button>
                </div>
                <p style="font-size: 0.8rem; margin-top: 10px; color: #3b6d85;">
                    â€» åˆ—å°æ™‚å»ºè­°ä½¿ç”¨æ¨™ç±¤ç´™(A4) Â· ç›´æ¥æŒ‰ç€è¦½å™¨åˆ—å°ï¼Œå¯è‡ªè¡Œèª¿æ•´ç¸®æ”¾ã€‚æ¯å€‹æ¨™ç±¤å·¦æ¡†é¡è‰²ä»£è¡¨çµ„åˆ¥ã€‚
                </p>
            </div>
        </div>
    </div>
    <hr>
    <div style="display: flex; gap: 30px; justify-content: space-between; flex-wrap: wrap;">
        <div style="font-size: 0.9rem; color: #1a576b;"><span style="font-weight:700;">ğŸ’¡ æ“ä½œæµç¨‹ï¼š</span> â‘ è²¼ä¸Šåå–®â†’è¼‰å…¥ â‘¡å‹¾é¸ä»Šå¤©å¯¦éš›å‡ºå¸­ â‘¢è¨­å®šåˆ†çµ„æ•¸â†’æŒ‰åˆ†çµ„ â‘£å³å´ç«‹å³å‡ºæ¨™ç±¤ï¼Œå¯åˆ—å°ã€‚</div>
        <div style="display: flex; gap: 8px;" id="dynamicGroupIndicators"></div>
    </div>
    <div class="footer-note">
        âš¡ ç³»çµ±è‡ªå‹•ç‚ºã€Œå‡ºå¸­å­¸ç”Ÿã€å¹³å‡åˆ†çµ„ï¼Œä¸¦ç‚ºæ¯ä½å­¸ç”Ÿç”¢ç”Ÿã€Œå­¸ç”Ÿå§“åã€æ¨™ç±¤ & ã€Œå­¸ç”Ÿå§“åï¼‹å®¶é•·ã€æ¨™ç±¤ã€‚çµ„åˆ¥é¡è‰²ä¸åŒï¼Œä¸€ç›®ç­ç„¶ã€‚
    </div>
</div>

<script>
    (function(){
        'use strict';

        // ----- ç‹€æ…‹ç®¡ç† -----
        let masterStudentList = [];        // åŸå§‹æ‰€æœ‰å ±åå­¸ç”Ÿ (å­—ä¸²é™£åˆ—)
        let attendanceChecked = [];       // å¸ƒæ—é™£åˆ—ï¼Œèˆ‡masterStudentListå°æ‡‰, true=å‡ºå¸­
        let currentGroups = [];           // åˆ†çµ„å¾Œ: [{ groupId, groupName, studentNames: [...] }, ...]
        let groupColors = [];            // å„çµ„é¡è‰² (åå…­é€²ä½)
        
        // é è¨­é…è‰² (å¯æ“´å……)
        const colorSet = [
            '#FFB3BA', '#C4E6C3', '#B5D3E7', '#FFD8B1', '#E0BBE4', '#FEE08B', 
            '#FBC7C7', '#ACE7C4', '#A0C4FF', '#FFC6A8', '#D4B8D9', '#C0E0DF'
        ];

        // ----- DOM å…ƒç´  -----
        const studentMasterInput = document.getElementById('studentMasterInput');
        const loadMasterBtn = document.getElementById('loadMasterBtn');
        const checklistContainer = document.getElementById('studentChecklistContainer');
        const attendanceCountSpan = document.getElementById('attendanceCount');
        const groupCountInput = document.getElementById('groupCount');
        const assignGroupsBtn = document.getElementById('assignGroupsBtn');
        const groupSummaryDiv = document.getElementById('groupSummary');
        const labelPreviewArea = document.getElementById('labelPreviewArea');
        const colorPaletteDiv = document.getElementById('colorPalette');
        const printLabelsBtn = document.getElementById('printLabelsBtn');
        const clearLabelsBtn = document.getElementById('clearLabelsBtn');
        const checkAllBtn = document.getElementById('checkAllBtn');
        const uncheckAllBtn = document.getElementById('uncheckAllBtn');

        // ----- è¼”åŠ©å‡½å¼ -----
        function generateGroupColors(groupCount) {
            groupColors = [];
            for (let i = 0; i < groupCount; i++) {
                groupColors.push(colorSet[i % colorSet.length]);
            }
            renderColorPalette();
        }

        function renderColorPalette() {
            if (!colorPaletteDiv) return;
            let html = '';
            currentGroups.forEach((g, idx) => {
                const color = groupColors[idx] || '#cccccc';
                html += `<span><span class="color-indicator" style="background:${color};"></span> ${g.groupName}</span>`;
            });
            colorPaletteDiv.innerHTML = html || '<span>å°šæœªåˆ†çµ„</span>';
        }

        // æ¸²æŸ“é»åæ ¸å–æ¸…å–® (æ ¹æ“šmasterStudentList)
        function renderChecklist() {
            if (!masterStudentList || masterStudentList.length === 0) {
                checklistContainer.innerHTML = '<div style="color: #6a8ca0; text-align: center; padding: 20px;">âš ï¸ å°šæœªè¼‰å…¥åå–®ï¼Œè«‹å…ˆè²¼ä¸Šå­¸ç”Ÿå§“åä¸¦æŒ‰ã€Œè¼‰å…¥åå–®ã€ã€‚</div>';
                attendanceCountSpan.innerText = '0/0';
                return;
            }
            // ç¢ºä¿ attendanceChecked é•·åº¦ä¸€è‡´
            while (attendanceChecked.length < masterStudentList.length) attendanceChecked.push(true);  // é è¨­å‡ºå¸­ç‚ºtrueæ–¹ä¾¿
            while (attendanceChecked.length > masterStudentList.length) attendanceChecked.pop();
            
            let html = '';
            masterStudentList.forEach((student, index) => {
                const isChecked = attendanceChecked[index] ? 'checked' : '';
                html += `<div class="student-item">
                            <input type="checkbox" id="chk_${index}" ${isChecked} data-index="${index}">
                            <label for="chk_${index}" style="flex:1; font-weight:500;">${escapeHtml(student)}</label>
                        </div>`;
            });
            checklistContainer.innerHTML = html;
            updateAttendanceCount();
            
            // ç¶å®š checkbox äº‹ä»¶
            document.querySelectorAll('.student-item input[type=checkbox]').forEach(chk => {
                chk.addEventListener('change', function(e) {
                    const idx = parseInt(this.dataset.index, 10);
                    if (!isNaN(idx) && idx >= 0 && idx < attendanceChecked.length) {
                        attendanceChecked[idx] = this.checked;
                        updateAttendanceCount();
                    }
                });
            });
        }

        // ç°¡å–®è·³è„«
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.replace(/[&<>"]/g, function(m) {
                if(m === '&') return '&amp;';
                if(m === '<') return '&lt;';
                if(m === '>') return '&gt;';
                if(m === '"') return '&quot;';
                return m;
            });
        }

        // æ›´æ–°å‡ºå¸­äººæ•¸é¡¯ç¤º
        function updateAttendanceCount() {
            const total = masterStudentList.length;
            const checkedCount = attendanceChecked.filter(v => v === true).length;
            attendanceCountSpan.innerText = `${checkedCount}/${total}`;
        }

        // å–å¾—å‡ºå¸­å­¸ç”Ÿåå–®
        function getPresentStudentList() {
            return masterStudentList.filter((_, idx) => attendanceChecked[idx] === true);
        }

        // **** æ ¸å¿ƒï¼šå¹³å‡åˆ†çµ„æ¼”ç®—æ³• ****
        function assignToGroups() {
            const presentList = getPresentStudentList();
            const groupCount = parseInt(groupCountInput.value, 10);
            if (isNaN(groupCount) || groupCount <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„çµ„æ•¸ (è‡³å°‘1çµ„)');
                return;
            }
            if (presentList.length === 0) {
                alert('ä»Šå¤©æ²’æœ‰å‡ºå¸­å­¸ç”Ÿï¼Œç„¡æ³•åˆ†çµ„ã€‚è«‹å‹¾é¸å‡ºå¸­å­¸ç”Ÿã€‚');
                return;
            }

            // å¹³å‡åˆ†é…
            const shuffled = [...presentList]; // æˆ‘å€‘ä¾ç…§åŸå§‹é †åºåˆ†é…å³å¯é”åˆ°åŸºæœ¬å¹³å‡(ä¿ç•™éš¨æ©Ÿæ€§? å¯éš¨æ©Ÿæ´—ç‰Œï¼Œä½†å­¸æ ¡å¯èƒ½å¸Œæœ›ç…§é †åºï¼Œæ¡ç”¨ä¾åºè¼ªæµ)
            // ä½†å¹³å‡åˆ†çµ„æœ€å¥½ç¨å¾®éš¨æ©Ÿåˆ†é…? ä½†ç‚ºç°¡å–®æ¸…æ¥šï¼Œä½¿ç”¨Så‹æˆ–è¼ªæµã€‚é€™è£¡æ¡ç”¨ã€Œè¼ªæµåˆ†ç™¼ã€ä»¥é”å¹³å‡
            const groups = Array.from({ length: groupCount }, () => []);
            for (let i = 0; i < shuffled.length; i++) {
                const groupIdx = i % groupCount;
                groups[groupIdx].push(shuffled[i]);
            }
            
            // å»ºæ§‹ currentGroups
            currentGroups = groups.map((students, idx) => ({
                groupId: idx + 1,
                groupName: `ç¬¬ ${idx + 1} çµ„`,
                studentNames: students
            }));
            
            generateGroupColors(groupCount);
            renderGroupSummary();
            generateLabels();    // ç«‹å³ç”¢ç”Ÿæ¨™ç±¤é è¦½
        }

        // é¡¯ç¤ºåˆ†çµ„æ‘˜è¦
        function renderGroupSummary() {
            if (!currentGroups || currentGroups.length === 0) {
                groupSummaryDiv.innerHTML = '<p style="color: #396377;">å°šæœªé€²è¡Œåˆ†çµ„ï¼Œè«‹è¨­å®šçµ„æ•¸ä¸¦é»æ“Šåˆ†çµ„ã€‚</p>';
                return;
            }
            let html = '<ul style="list-style-type:none; padding-left:0;">';
            currentGroups.forEach((g, i) => {
                const color = groupColors[i] || '#aaa';
                html += `<li style="margin-bottom: 12px; display: flex; align-items: center;">
                            <span class="color-indicator" style="background: ${color};"></span>
                            <span style="font-weight:600; min-width: 80px;">${g.groupName}</span>
                            <span style="background: #f4f9fd; padding: 3px 12px; border-radius: 30px;">
                                ${g.studentNames.length} äºº
                            </span>
                            <span style="margin-left: 12px; color: #2e5c73;">${g.studentNames.join('ã€')}</span>
                        </li>`;
            });
            html += `</ul><p style="margin-top:8px;">âœ… ç¸½å‡ºå¸­äººæ•¸ï¼š${getPresentStudentList().length} äººï¼Œå…± ${currentGroups.length} çµ„</p>`;
            groupSummaryDiv.innerHTML = html;
        }

        // **** ç”¢ç”Ÿå­¸ç”Ÿ+å®¶é•·å½©è‰²æ¨™ç±¤ (æ¯å¼µlabelæ¸…æ¥šæ¨™ç¤º) ****
        function generateLabels() {
            if (!currentGroups || currentGroups.length === 0 || getPresentStudentList().length === 0) {
                labelPreviewArea.innerHTML = '<div style="color: #718e9e; width: 100%; text-align: center; padding: 20px;">ğŸ‘† è«‹å…ˆå®Œæˆåˆ†çµ„ï¼Œæ¨™ç±¤é è¦½å°‡é¡¯ç¤ºåœ¨é€™è£¡</div>';
                return;
            }

            let labelsHtml = '';
            // éæ­·æ¯ä¸€çµ„ï¼Œæ¯ä¸€å€‹å­¸ç”Ÿ
            currentGroups.forEach((group, groupIndex) => {
                const groupName = group.groupName;
                const borderColor = groupColors[groupIndex] || '#CCCCCC';
                
                group.studentNames.forEach(studentName => {
                    // 1. å­¸ç”Ÿæ¨™ç±¤
                    labelsHtml += `<div class="label-card" style="border-left-color: ${borderColor};">
                                    <div class="student-name">${escapeHtml(studentName)}</div>
                                    <div style="font-size:0.8rem; color: #34626c;">å­¸ç”Ÿ</div>
                                    <span class="group-tag">${groupName}</span>
                                </div>`;
                    
                    // 2. å®¶é•·æ¨™ç±¤ï¼š ã€Œé™³å¤§æ–‡å®¶é•·ã€
                    labelsHtml += `<div class="label-card" style="border-left-color: ${borderColor};">
                                    <div class="student-name">${escapeHtml(studentName)}å®¶é•·</div>
                                    <div style="font-size:0.8rem; color: #8a6e4b;">å®¶é•·</div>
                                    <span class="group-tag">${groupName}</span>
                                </div>`;
                });
            });
            
            labelPreviewArea.innerHTML = labelsHtml;
        }

        // ----- åˆ—å°åŠŸèƒ½ (ç°¡å–®å‘¼å«ç€è¦½å™¨åˆ—å°ï¼Œåªåˆ—å°æ¨™ç±¤å€åŸŸ) -----
        function printLabels() {
            const labelContent = labelPreviewArea.innerHTML;
            if (!labelContent || labelContent.includes('è«‹å…ˆå®Œæˆåˆ†çµ„')) {
                alert('æ²’æœ‰å¯åˆ—å°çš„æ¨™ç±¤ï¼Œè«‹å…ˆåˆ†çµ„ç”¢ç”Ÿæ¨™ç±¤ã€‚');
                return;
            }
            
            // å»ºç«‹æ–°è¦–çª—é€²è¡Œåˆ—å°
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            if (!printWindow) {
                alert('è«‹å…è¨±å½ˆå‡ºè¦–çª—ä»¥ä¾¿åˆ—å°ã€‚');
                return;
            }
            
            const style = document.querySelector('style').innerHTML;
            const colorPaletteHtml = document.getElementById('colorPalette')?.innerHTML || '';
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>åˆ—å°åˆ†çµ„å½©è‰²æ¨™ç±¤ - å­¸ç”Ÿèˆ‡å®¶é•·</title>
                    <style>
                        ${style}
                        body { background: white; padding: 20px; }
                        .label-container { display: flex; flex-wrap: wrap; gap: 16px; }
                        .label-card { 
                            width: 180px; height: 100px; 
                            border-radius: 14px; background: white; 
                            box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
                            display: flex; flex-direction: column; 
                            justify-content: center; align-items: center; 
                            padding: 12px; border-left: 12px solid; 
                            page-break-inside: avoid; 
                            break-inside: avoid;
                        }
                        .print-header { margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h3>ğŸ·ï¸ åƒè§€åˆ†çµ„æ¨™ç±¤ Â· å­¸ç”Ÿï¼‹å®¶é•· (çµ„åˆ¥é¡è‰²æ¨™ç¤º)</h3>
                        <div style="display:flex; gap: 15px; flex-wrap:wrap;">${colorPaletteHtml}</div>
                        <hr>
                    </div>
                    <div class="label-container">
                        ${labelPreviewArea.innerHTML}
                    </div>
                    <p style="margin-top:30px; color:gray; font-size:0.8rem;">åˆ—å°æ™‚é–“: ${new Date().toLocaleString()}</p>
                    <script>window.onload = function() { window.print(); window.close(); } <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // æ¸…ç©ºé è¦½ (ä½†ä¿ç•™åˆ†çµ„)
        function clearPreview() {
            labelPreviewArea.innerHTML = '<div style="color: #718e9e; width: 100%; text-align: center; padding: 20px;">ğŸ§¹ æ¨™ç±¤å·²æ¸…ç©ºï¼Œå¯é‡æ–°åˆ†çµ„ç”¢ç”Ÿã€‚</div>';
        }

        // ----- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š -----
        function init() {
            // è¼‰å…¥åå–®æŒ‰éˆ•
            loadMasterBtn.addEventListener('click', function() {
                const rawText = studentMasterInput.value.trim();
                if (!rawText) {
                    alert('è«‹è¼¸å…¥å­¸ç”Ÿå§“åï¼Œæ¯è¡Œä¸€ä½');
                    return;
                }
                // æ‹†åˆ†æˆé™£åˆ—ï¼Œå»é™¤ç©ºè¡Œèˆ‡ç©ºç™½
                masterStudentList = rawText.split('\n')
                                        .map(s => s.trim())
                                        .filter(s => s !== '');
                if (masterStudentList.length === 0) return;
                
                // é è¨­æ‰€æœ‰å­¸ç”Ÿå‡ºå¸­ (true)
                attendanceChecked = new Array(masterStudentList.length).fill(true);
                renderChecklist();
                // åŒæ™‚æ¸…é™¤ä¹‹å‰åˆ†çµ„
                currentGroups = [];
                groupSummaryDiv.innerHTML = '<p style="color: #396377;">å·²è¼‰å…¥æ–°åå–®ï¼Œè«‹è¨­å®šçµ„æ•¸ä¸¦é€²è¡Œåˆ†çµ„ã€‚</p>';
                labelPreviewArea.innerHTML = '<div style="color: #718e9e; width: 100%; text-align: center; padding: 20px;">âœ… åå·²è¼‰å…¥ï¼Œè«‹é€²è¡Œåˆ†çµ„ã€‚</div>';
                colorPaletteDiv.innerHTML = '';
            });

            // å…¨é¸/å–æ¶ˆ
            checkAllBtn.addEventListener('click', function() {
                attendanceChecked = attendanceChecked.map(() => true);
                renderChecklist();
            });
            uncheckAllBtn.addEventListener('click', function() {
                attendanceChecked = attendanceChecked.map(() => false);
                renderChecklist();
            });

            // åˆ†çµ„æŒ‰éˆ•
            assignGroupsBtn.addEventListener('click', assignToGroups);

            // åˆ—å°
            printLabelsBtn.addEventListener('click', printLabels);
            
            // æ¸…ç©ºæ¨™ç±¤é è¦½(åƒ…è¦–è¦º)
            clearLabelsBtn.addEventListener('click', clearPreview);

            // é»æ“Šçµ„æ•¸è¼¸å…¥æ¡†é™åˆ¶
            // åˆå§‹åŒ–é è¨­è¼‰å…¥demoåå–®(æ–¹ä¾¿æ¸¬è©¦)
            setTimeout(() => {
                if (masterStudentList.length === 0) {
                    // è‡ªå‹•è¼‰å…¥é è¨­ç¯„ä¾‹
                    const demoText = studentMasterInput.value.trim();
                    if (demoText) {
                        masterStudentList = demoText.split('\n').map(s => s.trim()).filter(s => s !== '');
                        attendanceChecked = new Array(masterStudentList.length).fill(true);
                        renderChecklist();
                    }
                }
            }, 50);
        }

        init();
    })();
</script>

</body>
</html>
